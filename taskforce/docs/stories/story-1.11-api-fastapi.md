# Story 1.11: Implement API Layer - FastAPI REST Service

**Epic**: Build Taskforce Production Framework with Clean Architecture  
**Story ID**: 1.11  
**Status**: Pending  
**Priority**: High  
**Estimated Points**: 4  
**Dependencies**: Story 1.10 (Executor Service)

---

## User Story

As a **developer**,  
I want **a FastAPI REST API exposing agent execution**,  
so that **Taskforce can be deployed as a microservice**.

---

## Acceptance Criteria

1. ✅ Create `taskforce/src/taskforce/api/server.py` with FastAPI app
2. ✅ Create `taskforce/src/taskforce/api/routes/execution.py` with endpoints:
   - `POST /execute` - Execute agent mission (returns session_id, streams progress)
   - `GET /sessions` - List all sessions
   - `GET /sessions/{session_id}` - Get session details and state
   - `POST /sessions` - Create new session
   - `GET /health` - Health check (liveness probe)
   - `GET /health/ready` - Readiness check (verifies DB connectivity)
3. ✅ Endpoints use `AgentExecutor` service from application layer
4. ✅ Support for Server-Sent Events or WebSocket for streaming progress
5. ✅ Proper HTTP status codes and error responses
6. ✅ CORS middleware configuration
7. ✅ OpenAPI documentation auto-generated by FastAPI
8. ✅ Integration tests via TestClient verify all endpoints

---

## Integration Verification

- **IV1: Existing Functionality Verification** - Agent V2 CLI continues to function
- **IV2: Integration Point Verification** - API-executed missions produce same results as CLI-executed missions
- **IV3: Performance Impact Verification** - API overhead <100ms per request (excluding actual mission execution time)

---

## Technical Notes

**FastAPI Server:**

```python
# taskforce/src/taskforce/api/server.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import structlog
from taskforce.api.routes import execution, health, sessions

logger = structlog.get_logger()

def create_app() -> FastAPI:
    """Create and configure FastAPI application."""
    
    app = FastAPI(
        title="Taskforce Agent API",
        description="Production-ready ReAct agent framework with Clean Architecture",
        version="1.0.0",
        docs_url="/docs",
        redoc_url="/redoc"
    )
    
    # CORS middleware
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],  # Configure based on environment
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"]
    )
    
    # Include routers
    app.include_router(execution.router, prefix="/api/v1", tags=["execution"])
    app.include_router(sessions.router, prefix="/api/v1", tags=["sessions"])
    app.include_router(health.router, tags=["health"])
    
    # Startup/shutdown events
    @app.on_event("startup")
    async def startup_event():
        logger.info("fastapi.startup", message="Taskforce API starting...")
    
    @app.on_event("shutdown")
    async def shutdown_event():
        logger.info("fastapi.shutdown", message="Taskforce API shutting down...")
    
    return app

app = create_app()

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**Execution Endpoints:**

```python
# taskforce/src/taskforce/api/routes/execution.py
from fastapi import APIRouter, HTTPException, BackgroundTasks
from fastapi.responses import StreamingResponse
from pydantic import BaseModel
from typing import Optional
from taskforce.application.executor import AgentExecutor

router = APIRouter()
executor = AgentExecutor()

class ExecuteMissionRequest(BaseModel):
    """Request to execute a mission."""
    mission: str
    profile: str = "dev"
    session_id: Optional[str] = None

class ExecuteMissionResponse(BaseModel):
    """Response from mission execution."""
    session_id: str
    status: str
    message: str

@router.post("/execute", response_model=ExecuteMissionResponse)
async def execute_mission(request: ExecuteMissionRequest):
    """Execute agent mission synchronously."""
    try:
        result = await executor.execute_mission(
            mission=request.mission,
            profile=request.profile,
            session_id=request.session_id
        )
        
        return ExecuteMissionResponse(
            session_id=result.session_id,
            status=result.status,
            message=result.final_message
        )
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

@router.post("/execute/stream")
async def execute_mission_stream(request: ExecuteMissionRequest):
    """Execute agent mission with streaming progress via SSE."""
    
    async def event_generator():
        async for update in executor.execute_mission_streaming(
            mission=request.mission,
            profile=request.profile,
            session_id=request.session_id
        ):
            yield f"data: {update.to_json()}\n\n"
    
    return StreamingResponse(event_generator(), media_type="text/event-stream")
```

**Health Endpoints:**

```python
# taskforce/src/taskforce/api/routes/health.py
from fastapi import APIRouter, status
from pydantic import BaseModel

router = APIRouter()

class HealthResponse(BaseModel):
    status: str
    version: str

@router.get("/health", response_model=HealthResponse)
async def health_check():
    """Liveness probe - is the service running?"""
    return HealthResponse(status="healthy", version="1.0.0")

@router.get("/health/ready", response_model=HealthResponse)
async def readiness_check():
    """Readiness probe - can the service handle requests?"""
    # Check dependencies (DB, external APIs)
    try:
        # Test DB connectivity
        # await check_database_connection()
        return HealthResponse(status="ready", version="1.0.0")
    except Exception as e:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=f"Service not ready: {str(e)}"
        )
```

**Sessions Endpoints:**

```python
# taskforce/src/taskforce/api/routes/sessions.py
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from taskforce.application.factory import AgentFactory

router = APIRouter()
factory = AgentFactory()

class SessionResponse(BaseModel):
    session_id: str
    mission: str
    status: str
    created_at: str

@router.get("/sessions", response_model=List[SessionResponse])
async def list_sessions(profile: str = "dev"):
    """List all agent sessions."""
    agent = factory.create_agent(profile=profile)
    sessions = await agent.state_manager.list_sessions()
    
    # Load details for each session
    results = []
    for session_id in sessions:
        state = await agent.state_manager.load_state(session_id)
        if state:
            results.append(SessionResponse(
                session_id=session_id,
                mission=state.get("mission", ""),
                status=state.get("status", "unknown"),
                created_at=state.get("created_at", "")
            ))
    
    return results

@router.get("/sessions/{session_id}", response_model=SessionResponse)
async def get_session(session_id: str, profile: str = "dev"):
    """Get session details."""
    agent = factory.create_agent(profile=profile)
    state = await agent.state_manager.load_state(session_id)
    
    if not state:
        raise HTTPException(status_code=404, detail="Session not found")
    
    return SessionResponse(
        session_id=session_id,
        mission=state.get("mission", ""),
        status=state.get("status", ""),
        created_at=state.get("created_at", "")
    )
```

---

## Testing Strategy

```python
# tests/integration/test_api_endpoints.py
from fastapi.testclient import TestClient
from taskforce.api.server import app

client = TestClient(app)

def test_health_endpoint():
    response = client.get("/health")
    assert response.status_code == 200
    assert response.json()["status"] == "healthy"

def test_execute_mission_endpoint():
    response = client.post(
        "/api/v1/execute",
        json={
            "mission": "Create a simple Python function",
            "profile": "dev"
        }
    )
    
    assert response.status_code == 200
    data = response.json()
    assert "session_id" in data
    assert data["status"] in ["completed", "failed", "in_progress"]

def test_list_sessions_endpoint():
    response = client.get("/api/v1/sessions")
    assert response.status_code == 200
    assert isinstance(response.json(), list)

def test_streaming_execution():
    with client.stream(
        "POST",
        "/api/v1/execute/stream",
        json={"mission": "Test", "profile": "dev"}
    ) as response:
        assert response.status_code == 200
        assert response.headers["content-type"] == "text/event-stream"
        
        # Read some events
        events = []
        for line in response.iter_lines():
            if line.startswith("data:"):
                events.append(line)
                if len(events) >= 3:
                    break
        
        assert len(events) > 0
```

---

## Definition of Done

- [ ] FastAPI app created with all endpoints
- [ ] Execution endpoints (sync and streaming) implemented
- [ ] Health endpoints (liveness and readiness) implemented
- [ ] Sessions endpoints (list and get) implemented
- [ ] CORS middleware configured
- [ ] OpenAPI documentation generated
- [ ] Integration tests via TestClient (≥80% coverage)
- [ ] API overhead <100ms per request
- [ ] Code review completed
- [ ] Code committed to version control

